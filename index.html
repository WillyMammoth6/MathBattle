<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Dragon Battle</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #121212;
            font-family: Arial, sans-serif;
            overflow: hidden;
            color: #fff;
        }
        #gameCanvas {
            width: 100%;
            max-width: 600px;
            height: 50vh;
            background-color: #001f3f; /* Fallback dark night sky */
            touch-action: none;
        }
        #question {
            font-size: 24px;
            margin: 10px 0;
            text-align: center;
        }
        #inputDisplay {
            font-size: 28px;
            margin: 10px 0;
            padding: 10px;
            border: 2px solid #fff;
            width: 200px;
            text-align: center;
            background-color: #222;
            color: #fff;
        }
        #numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 300px;
            width: 100%;
        }
        .numButton {
            font-size: 24px;
            padding: 20px;
            background-color: #333;
            border: 1px solid #555;
            text-align: center;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
            color: #fff;
        }
        #message {
            font-size: 32px;
            margin-top: 20px;
            text-align: center;
            color: red;
            display: none;
        }
        #restartButton {
            font-size: 24px;
            padding: 10px 20px;
            background-color: #444;
            color: #fff;
            border: 1px solid #666;
            cursor: pointer;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="question"></div>
    <div id="inputDisplay"> </div>
    <div id="numpad">
        <div class="numButton" onclick="appendNumber('1')">1</div>
        <div class="numButton" onclick="appendNumber('2')">2</div>
        <div class="numButton" onclick="appendNumber('3')">3</div>
        <div class="numButton" onclick="appendNumber('4')">4</div>
        <div class="numButton" onclick="appendNumber('5')">5</div>
        <div class="numButton" onclick="appendNumber('6')">6</div>
        <div class="numButton" onclick="appendNumber('7')">7</div>
        <div class="numButton" onclick="appendNumber('8')">8</div>
        <div class="numButton" onclick="appendNumber('9')">9</div>
        <div class="numButton" id="delete" onclick="deleteLast()">⌦</div>
        <div class="numButton" onclick="appendNumber('0')">0</div>
        <div class="numButton" id="enter" onclick="submitAnswer()">=</div>
    </div>
    <div id="message"></div>
    <button id="restartButton" onclick="restartGame()">Restart Game</button>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const questionDiv = document.getElementById('question');
        const inputDisplay = document.getElementById('inputDisplay');
        const messageDiv = document.getElementById('message');
        const numpad = document.getElementById('numpad');
        const restartButton = document.getElementById('restartButton');

        // Set canvas size dynamically
        function resizeCanvas() {
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Background image
        const bgImage = new Image();
        bgImage.src = 'https://img.freepik.com/premium-photo/medieval-castle-background-fantasy-magical-illustration-palace-game-concept-art-design_573238-122.jpg';
        bgImage.onload = () => { /* Image loaded */ };

        // Game state
        let avatarHealth = 3;
        let dragonHealth = 3;
        let currentInput = '';
        let currentQuestion = {};
        let gameOver = false;
        let animationFrame = 0;
        let animating = false;
        let animationType = ''; // 'avatarAttack' or 'dragonAttack'
        let deathAnimationFrame = 0;
        let fireworksParticles = [];
        let fireParticles = [];

        // Particle class for fireworks and fire
        class Particle {
            constructor(x, y, vx, vy, color, life) {
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.color = color;
                this.life = life;
                this.initialLife = life;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.1; // Gravity
                this.life--;
            }
            draw() {
                ctx.fillStyle = this.color;
                ctx.globalAlpha = this.life / this.initialLife;
                ctx.beginPath();
                ctx.arc(this.x, this.y, 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        // Create fireworks
        function createFireworks() {
            for (let i = 0; i < 50; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 5 + 2;
                const color = `hsl(${Math.random() * 360}, 100%, 50%)`;
                fireworksParticles.push(new Particle(canvas.width / 2, canvas.height / 2, Math.cos(angle) * speed, Math.sin(angle) * speed - 5, color, 60));
            }
        }

        // Create fire on avatar
        function createFire() {
            for (let i = 0; i < 50; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 3 + 1;
                const color = Math.random() > 0.5 ? 'orange' : 'red';
                fireParticles.push(new Particle(100, canvas.height / 2, Math.cos(angle) * speed, Math.sin(angle) * speed - 3, color, 60));
            }
        }

        // Heart drawing functions
        function drawHeart(x, y, full) {
            ctx.beginPath();
            ctx.moveTo(x, y + 5);
            ctx.bezierCurveTo(x - 5, y, x - 10, y + 10, x, y + 15);
            ctx.bezierCurveTo(x + 10, y + 10, x + 5, y, x, y + 5);
            ctx.fillStyle = full ? 'red' : '#555';
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.stroke();
        }

        function drawHalfHeart(x, y) {
            ctx.beginPath();
            ctx.moveTo(x, y + 5);
            ctx.bezierCurveTo(x - 5, y, x - 10, y + 10, x, y + 15);
            ctx.lineTo(x, y + 5);
            ctx.fillStyle = 'red';
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.stroke();
        }

        // Draw avatar (stick figure knight)
        function drawAvatar(x, y, fallen = false) {
            ctx.strokeStyle = '#fff';
            if (fallen) {
                ctx.save();
                ctx.translate(x, y + 30);
                ctx.rotate(Math.PI / 2); // Fall to the side
                x = 0;
                y = -30;
            }
            // Body
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x, y + 40);
            ctx.stroke();

            // Head
            ctx.beginPath();
            ctx.arc(x, y - 10, 10, 0, Math.PI * 2);
            ctx.stroke();

            // Helmet
            ctx.beginPath();
            ctx.moveTo(x - 10, y - 20);
            ctx.lineTo(x + 10, y - 20);
            ctx.lineTo(x, y - 30);
            ctx.closePath();
            ctx.stroke();

            // Arms
            ctx.beginPath();
            ctx.moveTo(x, y + 10);
            ctx.lineTo(x - 15, y + 20);
            ctx.moveTo(x, y + 10);
            ctx.lineTo(x + 15, y + 20);
            ctx.stroke();

            // Legs
            ctx.beginPath();
            ctx.moveTo(x, y + 40);
            ctx.lineTo(x - 10, y + 60);
            ctx.moveTo(x, y + 40);
            ctx.lineTo(x + 10, y + 60);
            ctx.stroke();

            // Larger claymore sword
            ctx.beginPath();
            ctx.moveTo(x + 15, y + 20);
            ctx.lineTo(x + 30, y - 10); // Longer blade
            ctx.lineTo(x + 40, y - 5);
            ctx.lineTo(x + 25, y + 25); // Back to hilt
            ctx.moveTo(x + 10, y + 15); // Crossguard
            ctx.lineTo(x + 20, y + 25);
            ctx.stroke();

            if (fallen) {
                ctx.restore();
            }
        }

        // Draw dragon
        function drawDragon(x, y, dead = false) {
            ctx.strokeStyle = '#fff';
            if (dead) {
                ctx.save();
                ctx.translate(x, y + 30);
                ctx.rotate(Math.PI); // Flip on back
                x = 0;
                y = -30;
            }
            // Body
            ctx.beginPath();
            ctx.ellipse(x, y + 20, 40, 20, 0, 0, Math.PI * 2);
            ctx.stroke();

            // Head
            ctx.beginPath();
            ctx.ellipse(x - 50, y, 20, 15, 0, 0, Math.PI * 2);
            ctx.stroke();

            // Eyes
            if (dead) {
                // X eyes
                ctx.beginPath();
                ctx.moveTo(x - 58, y - 7);
                ctx.lineTo(x - 52, y - 3);
                ctx.moveTo(x - 52, y - 7);
                ctx.lineTo(x - 58, y - 3);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x - 48, y - 7);
                ctx.lineTo(x - 42, y - 3);
                ctx.moveTo(x - 42, y - 7);
                ctx.lineTo(x - 48, y - 3);
                ctx.stroke();
            } else {
                // Normal eyes
                ctx.beginPath();
                ctx.arc(x - 55, y - 5, 2, 0, Math.PI * 2);
                ctx.arc(x - 45, y - 5, 2, 0, Math.PI * 2);
                ctx.fillStyle = 'red';
                ctx.fill();
            }

            // Mouth
            ctx.beginPath();
            ctx.moveTo(x - 60, y + 5);
            ctx.lineTo(x - 40, y + 5);
            ctx.stroke();

            // Wings
            ctx.beginPath();
            ctx.moveTo(x - 20, y + 10);
            ctx.lineTo(x - 30, y - 20);
            ctx.lineTo(x - 10, y - 10);
            ctx.moveTo(x + 20, y + 10);
            ctx.lineTo(x + 30, y - 20);
            ctx.lineTo(x + 10, y - 10);
            ctx.stroke();

            // Tail
            ctx.beginPath();
            ctx.moveTo(x + 40, y + 20);
            ctx.lineTo(x + 60, y + 30);
            ctx.lineTo(x + 70, y + 20);
            ctx.stroke();

            // Legs
            ctx.beginPath();
            ctx.moveTo(x - 20, y + 40);
            ctx.lineTo(x - 25, y + 50);
            ctx.moveTo(x + 20, y + 40);
            ctx.lineTo(x + 25, y + 50);
            ctx.stroke();

            if (dead) {
                ctx.restore();
            }
        }

        // Draw fire breath animation
        function drawFire(x, y, frame) {
            ctx.fillStyle = 'orange';
            ctx.beginPath();
            ctx.moveTo(x, y);
            for (let i = 0; i < 5; i++) {
                const offset = Math.sin(frame / 5 + i) * 5;
                ctx.lineTo(x - 20 - i * 10, y + offset);
            }
            ctx.fill();
        }

        // Draw sword swing animation
        function drawSwordSwing(x, y, frame) {
            ctx.save();
            ctx.translate(x + 15, y + 20);
            ctx.rotate((frame / 20) * Math.PI);
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(15, -15); // Larger swing for claymore
            ctx.lineTo(25, -10);
            ctx.strokeStyle = '#fff';
            ctx.stroke();
            ctx.restore();
        }

        // Render health hearts
        function renderHealth() {
            if (gameOver) return; // No health bars on death
            // Avatar hearts
            for (let i = 0; i < 3; i++) {
                const heartX = 50 + i * 30;
                const heartY = 20;
                if (avatarHealth >= i + 1) {
                    drawHeart(heartX, heartY, true);
                } else if (avatarHealth >= i + 0.5) {
                    drawHalfHeart(heartX, heartY);
                } else {
                    drawHeart(heartX, heartY, false);
                }
            }

            // Dragon hearts
            for (let i = 0; i < 3; i++) {
                const heartX = canvas.width - 50 - i * 30;
                const heartY = 20;
                if (dragonHealth >= i + 1) {
                    drawHeart(heartX, heartY, true);
                } else if (dragonHealth >= i + 0.5) {
                    drawHalfHeart(heartX, heartY);
                } else {
                    drawHeart(heartX, heartY, false);
                }
            }
        }

        // Main draw function
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw background image
            if (bgImage.complete) {
                ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
            }

            // Draw avatar
            drawAvatar(100, canvas.height / 2 - 30, gameOver && avatarHealth <= 0);

            // Draw dragon
            drawDragon(canvas.width - 100, canvas.height / 2 - 30, gameOver && dragonHealth <= 0);

            // Render health (only if not game over)
            renderHealth();

            if (animating) {
                if (animationType === 'avatarAttack') {
                    drawSwordSwing(100, canvas.height / 2 - 30, animationFrame);
                } else if (animationType === 'dragonAttack') {
                    drawFire(canvas.width - 150, canvas.height / 2, animationFrame);
                }
                animationFrame++;
                if (animationFrame > 20) {
                    animating = false;
                    animationFrame = 0;
                    if (gameOver) {
                        numpad.style.display = 'none';
                        questionDiv.textContent = '';
                        inputDisplay.textContent = '';
                        restartButton.style.display = 'block';
                        deathAnimationFrame = 0;
                        if (dragonHealth <= 0) {
                            createFireworks();
                        } else {
                            createFire();
                        }
                    }
                }
            }

            if (gameOver) {
                // Animate fireworks or fire
                if (dragonHealth <= 0) {
                    fireworksParticles.forEach((p, index) => {
                        p.update();
                        p.draw();
                        if (p.life <= 0) fireworksParticles.splice(index, 1);
                    });
                } else {
                    fireParticles.forEach((p, index) => {
                        p.update();
                        p.draw();
                        if (p.life <= 0) fireParticles.splice(index, 1);
                    });
                }
                deathAnimationFrame++;
                if (deathAnimationFrame > 60) {
                    // Stop after some time, but particles handle themselves
                }
            }
        }

        // Animation loop
        function animate() {
            draw();
            requestAnimationFrame(animate);
        }
        animate();

        // Generate random math question
        function generateQuestion() {
            const ops = ['+', '-', '*', '/'];
            const op = ops[Math.floor(Math.random() * ops.length)];
            let a = Math.floor(Math.random() * 12) + 1;
            let b = Math.floor(Math.random() * 12) + 1;
            let answer;
            let opSymbol = op;

            if (op === '+') {
                answer = a + b;
            } else if (op === '-') {
                if (a < b) [a, b] = [b, a];
                answer = a - b;
            } else if (op === '*') {
                answer = a * b;
                opSymbol = '×';
            } else if (op === '/') {
                while (a % b !== 0) {
                    b = Math.floor(Math.random() * 12) + 1;
                }
                answer = a / b;
                opSymbol = '÷';
            }

            questionDiv.textContent = `${a} ${opSymbol} ${b} = ?`;
            return { op, a, b, answer };
        }

        // Start game
        currentQuestion = generateQuestion();

        // Input functions
        function appendNumber(num) {
            if (gameOver) return;
            if (currentInput.length < 3) { // Limit input to 3 digits max
                currentInput += num;
                inputDisplay.textContent = currentInput;
            }
        }

        function deleteLast() {
            if (gameOver) return;
            currentInput = currentInput.slice(0, -1);
            inputDisplay.textContent = currentInput;
        }

        function submitAnswer() {
            if (gameOver || currentInput === '') return;
            const userAnswer = parseInt(currentInput, 10);
            const correct = userAnswer === currentQuestion.answer;

            if (correct) {
                dragonHealth -= 0.5;
                animating = true;
                animationType = 'avatarAttack';
                if (dragonHealth <= 0) {
                    gameOver = true;
                    messageDiv.textContent = 'You Win! The dragon is defeated!';
                    messageDiv.style.color = 'green';
                    messageDiv.style.display = 'block';
                }
            } else {
                avatarHealth -= 0.5;
                animating = true;
                animationType = 'dragonAttack';
                if (avatarHealth <= 0) {
                    gameOver = true;
                    messageDiv.textContent = 'Game Over! The dragon wins.';
                    messageDiv.style.color = 'red';
                    messageDiv.style.display = 'block';
                }
            }

            currentInput = '';
            inputDisplay.textContent = '';
            if (!gameOver) {
                currentQuestion = generateQuestion();
            }
        }

        function restartGame() {
            avatarHealth = 3;
            dragonHealth = 3;
            gameOver = false;
            messageDiv.style.display = 'none';
            restartButton.style.display = 'none';
            numpad.style.display = 'grid';
            currentQuestion = generateQuestion();
            inputDisplay.textContent = '';
            currentInput = '';
            fireworksParticles = [];
            fireParticles = [];
        }
    </script>
</body>
</html>
